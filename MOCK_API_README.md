# Mock Grok API для отладки DnD Bot

Эта система позволяет тестировать бота без обращения к реальному Grok API, используя заранее подготовленные ответы.

## Быстрый старт

### 1. Установите Flask (если еще не установлен):
```bash
pip install flask
```

### 2. Запустите mock API сервер:
```bash
python mock_grok_api.py
```
или используйте batch файл:
```bash
start_mock_api.bat
```

### 3. В другом терминале запустите бота в mock режиме:
```bash
python start_bot.py mock
```

## Как это работает

### Mock API сервер
- Запускается на `http://localhost:5000`
- Эмулирует Grok API, отвечая в формате OpenAI
- Выбирает ответ из файлов в папке `mock_responses/` на основе содержимого запроса

### Логика выбора ответов
- **adventure_intro.txt** - если запрос содержит "создай захватывающее вступление"
- **combat_start.txt** - если в действиях игроков есть слова связанные с боем
- **continue_adventure.txt** - для обычных действий игроков
- **combat_end.txt** - если запрос о завершении сражения
- **default.txt** - для всех остальных случаев

### Структура файлов ответов
```
mock_responses/
├── adventure_intro.txt    # Ответ для начала приключения
├── combat_start.txt       # Ответ с началом боя (содержит ***COMBAT_START***)
├── continue_adventure.txt # Обычное продолжение приключения
├── combat_end.txt         # Окончание боя (содержит ***XP_REWARD***)
└── default.txt           # Дефолтный ответ
```

## Настройка ответов

Вы можете редактировать файлы в `mock_responses/` для тестирования различных сценариев:

### Формат боевых ответов
Для тестирования боя включите `***COMBAT_START***` и блоки врагов:
```
***COMBAT_START***

```
ENEMY: Имя врага
HP: 50
STR: 16 (мод: +3)
DEX: 14 (мод: +2)
CON: 15 (мод: +2)
INT: 10 (мод: +0)
WIS: 12 (мод: +1)
CHA: 8 (мод: -1)
ATTACK: Меч (1d8+3 slashing, бонус к атаке: +5)
ATTACK: Укус (1d6+3 piercing, бонус к атаке: +5)
XP: 300
```
```

### Формат награды опытом
Для тестирования системы опыта добавьте:
```
***XP_REWARD: 100***
```

## API Endpoints

### POST /v1/chat/completions
Основной endpoint для чат-запросов (совместим с OpenAI API)

### GET /health
Проверка статуса сервера

### GET /responses
Список доступных файлов ответов

## Отладка

### Логи mock сервера
Mock API сервер показывает:
- Количество сообщений в запросе
- Какой файл ответа был выбран
- Длину отправляемого ответа

### Логи бота
В mock режиме бот показывает:
- Что он подключен к mock API
- Все те же DEBUG сообщения что и с реальным API

## Примеры использования

### Тестирование боя
1. Отредактируйте `combat_start.txt` с нужными врагами
2. Используйте команду `/action атаковать врага` в боте
3. Бот получит ответ с `***COMBAT_START***` и начнет бой

### Тестирование множественных атак
В `combat_start.txt` добавьте несколько строк `ATTACK:` для одного врага:
```
ATTACK: Меч (1d8+3 slashing, бонус к атаке: +5)
ATTACK: Укус (1d6+3 piercing, бонус к атаке: +5)
ATTACK: Коготь (1d4+3 slashing, бонус к атаке: +4)
```

### Тестирование опыта
В любой файл ответа добавьте `***XP_REWARD: 150***`

## Переключение между режимами

### Обычный режим (реальный Grok API):
```bash
python start_bot.py
```

### Mock режим:
```bash
python start_bot.py mock
```

## Ограничения

- Mock API не сохраняет состояние между запросами
- Выбор ответа основан на простых текстовых паттернах
- Не эмулирует ошибки сети или API лимиты

## Расширение

Для добавления новых типов ответов:
1. Создайте новый `.txt` файл в `mock_responses/`
2. Добавьте логику выбора в функцию `get_mock_response()` в `mock_grok_api.py`
